<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Virtual Joystick Demo</title>
  <style>
    html, body { height: 100%; margin: 0; touch-action: none; overflow: hidden; }
    #game { width: 100%; height: 100%; }
    .joystick-base {
      position: absolute;
      border: 1px solid #fff;
      border-radius: 50%;
      backdrop-filter: blur(4px);
    }
    .joystick-thumb {
      position: absolute;
      background: linear-gradient(#FFAE00, #FF6A00);
      border: 4px solid #fff;
      border-radius: 50%;
      box-sizing: border-box;
    }
    #controls {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 40px 40px;
      box-sizing: border-box;
    }
    #actions {
      display: flex;
      gap: 24px;
    }
    .action-btn {
      width: 60px;
      height: 60px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.4);
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
    }
    .action-btn img {
      width: 20px;
      height: 20px;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
</head>
<body>
  <div id="game"></div>
<script>
(() => {
  const SPEED = 200;
  const config = {
    type: Phaser.AUTO,
    parent: 'game',
    width: window.innerWidth,
    height: window.innerHeight,
    physics: { default: 'arcade', arcade: { debug: false } },
    scene: { preload, create, update }
  };

  let player;
  let joystickBase, joystickThumb, joystickContainer;
  const joystickVector = new Phaser.Math.Vector2();
  let joystickPointer = null;
  let facing = 'right';
  let attackBtn, shieldBtn, controls, actionsContainer;
  let baseX, baseY;

  new Phaser.Game(config);

  function preload() {
    this.load.image('bg', '../images/background/background.png');
    // Load player left and right sprites
    this.load.image('playerLeft', 'assets/swim_shellfin_left.png');
    this.load.image('playerRight', 'assets/swim_shellfin_right.png');
  }

  function create() {
    const { width, height } = this.scale;

    this.add.image(width / 2, height / 2, 'bg').setDisplaySize(width, height);

    player = this.physics.add.image(width / 2, height / 2, 'playerRight')
      .setCollideWorldBounds(true)
      .setDisplaySize(150, 150);

    const baseRadius = 36;
    const thumbRadius = 24;

    controls = document.createElement('div');
    controls.id = 'controls';
    document.body.appendChild(controls);

    joystickContainer = document.createElement('div');
    joystickContainer.style.position = 'relative';
    joystickContainer.style.width = `${baseRadius * 2}px`;
    joystickContainer.style.height = `${baseRadius * 2}px`;
    controls.appendChild(joystickContainer);

    joystickBase = document.createElement('div');
    joystickBase.className = 'joystick-base';
    joystickBase.style.width = `${baseRadius * 2}px`;
    joystickBase.style.height = `${baseRadius * 2}px`;
    joystickBase.style.left = '0';
    joystickBase.style.top = '0';
    joystickBase.style.touchAction = 'none';
    joystickContainer.appendChild(joystickBase);

    joystickThumb = document.createElement('div');
    joystickThumb.className = 'joystick-thumb';
    joystickThumb.style.width = `${thumbRadius * 2}px`;
    joystickThumb.style.height = `${thumbRadius * 2}px`;
    joystickThumb.style.left = `${baseRadius - thumbRadius}px`;
    joystickThumb.style.top = `${baseRadius - thumbRadius}px`;
    joystickThumb.style.touchAction = 'none';
    joystickContainer.appendChild(joystickThumb);

    actionsContainer = document.createElement('div');
    actionsContainer.id = 'actions';
    controls.appendChild(actionsContainer);

    attackBtn = document.createElement('div');
    attackBtn.className = 'action-btn';
    attackBtn.innerHTML = '<img src="assets/attack.svg" alt="attack">';
    actionsContainer.appendChild(attackBtn);

    shieldBtn = document.createElement('div');
    shieldBtn.className = 'action-btn';
    shieldBtn.innerHTML = '<img src="assets/defend.svg" alt="defend">';
    actionsContainer.appendChild(shieldBtn);

    const rect = joystickContainer.getBoundingClientRect();
    baseX = rect.left + baseRadius;
    baseY = rect.top + baseRadius;

    // Bubble texture for attack
    const bubbleGfx = this.add.graphics();
    bubbleGfx.fillStyle(0x9bd7fb, 0.6).fillCircle(10, 10, 10);
    bubbleGfx.lineStyle(2, 0xffffff, 0.8).strokeCircle(10, 10, 10);
    bubbleGfx.generateTexture('bubble', 20, 20);
    bubbleGfx.destroy();

    joystickBase.addEventListener('pointerdown', startJoystick);
    joystickThumb.addEventListener('pointerdown', startJoystick);
    window.addEventListener('pointermove', moveJoystick);
    window.addEventListener('pointerup', endJoystick);

    attackBtn.addEventListener('pointerdown', () => {
      const offset = facing === 'right' ? 20 : -20;
      const bubble = this.physics.add.image(player.x + offset, player.y, 'bubble');
      bubble.setVelocity(facing === 'right' ? 300 : -300, 0);
    });

    this.input.on('pointerdown', pointer => {
      if (Phaser.Math.Distance.Between(pointer.x, pointer.y, baseX, baseY) <= baseRadius) {
        joystickPointer = pointer.id;
        moveThumb(pointer);
      }
    });

    function startJoystick(e) {
      joystickPointer = e.pointerId;
      moveThumb(e);
    }

    function moveJoystick(e) {
      if (e.pointerId === joystickPointer) {
        moveThumb(e);
      }
    }

    function endJoystick(e) {
      if (e.pointerId === joystickPointer) {
        joystickPointer = null;
        joystickThumb.style.left = `${baseRadius - thumbRadius}px`;
        joystickThumb.style.top = `${baseRadius - thumbRadius}px`;
        joystickVector.set(0, 0);
      }
    }

    function moveThumb(pointer) {
      const dx = pointer.x - baseX;
      const dy = pointer.y - baseY;
      joystickVector.set(dx, dy);
      const dist = Math.min(joystickVector.length(), baseRadius);
      const angle = joystickVector.angle();
      joystickThumb.style.left = `${baseRadius - thumbRadius + Math.cos(angle) * dist}px`;
      joystickThumb.style.top = `${baseRadius - thumbRadius + Math.sin(angle) * dist}px`;
    }
  }

  function update(time, delta) {
    if (joystickVector.length() > 0) {
      const dir = joystickVector.clone().normalize();
      player.x += dir.x * SPEED * (delta / 1000);
      player.y += dir.y * SPEED * (delta / 1000);

      if (Math.abs(dir.x) > 0.1) {
        facing = dir.x > 0 ? 'right' : 'left';
      }
      const texture = facing === 'right' ? 'playerRight' : 'playerLeft';
      player.setTexture(texture).setDisplaySize(150, 150);
    } else {
      const texture = facing === 'right' ? 'playerRight' : 'playerLeft';
      player.setTexture(texture).setDisplaySize(150, 150);
    }
  }
})();
</script>
</body>
</html>
