* {
  box-sizing: border-box;
}

body {
  margin: 0;
  min-height: 100vh;
  min-height: 100dvh;
  color: #272B34;
  background: url('../images/background/background.png') no-repeat center/cover;
  position: relative;
  overflow: hidden;
}

:root {
  --intro-sprite-offset: clamp(200px, 24vw, 280px);
}

@property --enemy-float-offset {
  syntax: '<length>';
  initial-value: 0px;
  inherits: false;
}

main.landing {
  position: relative;
  width: 100%;
  min-height: 100vh;
  min-height: 100dvh;
  opacity: 1;
  transform: translate3d(0, 0, 0);
  filter: none;
  transition: opacity 0.6s ease, transform 0.6s ease, filter 0.6s ease;
  will-change: opacity, transform, filter;
}

main.landing.is-battle-transition {
  animation: landing-battle-shift 0.6s cubic-bezier(0.22, 1, 0.36, 1) forwards;
}

body.is-preloading {
  overflow: hidden;
}

body.is-preloading main.landing {
  opacity: 0;
  transform: translate3d(0, 24px, 0) scale(0.98);
  filter: blur(6px);
  pointer-events: none;
}

body:not(.is-preloading) main.landing {
  opacity: 1;
  transform: translate3d(0, 0, 0) scale(1);
  filter: none;
}

.landing__hero-info {
  position: absolute;
  top: clamp(48px, 18vh, 180px);
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0;
  width: min(360px, 88vw);
  padding: 0 12px;
  text-align: center;
  z-index: 3;
}

.landing__hero-name,
.landing__hero-level {
  margin: 0;
}

.landing__hero-level {
  margin-top: 8px;
  opacity: 0.85;
}

.landing__hero-progress {
  --progress-gradient-start: #36dc36;
  --progress-gradient-end: #00b600;

  height: 18px;
  width: 100%;
  max-width: 140px;
  background-color: rgba(255, 255, 255, 0.25);
  box-shadow: 0 10px 24px rgba(0, 0, 0, 0.25);
  -webkit-backdrop-filter: blur(6px);
  backdrop-filter: blur(6px);
  border: 1px solid rgba(255, 255, 255, 0.9);
  margin-top: 24px;
}

.landing__hero-progress .progress__fill::after {
  inset: 3px 5px 0 5px;
}

.landing__actions {
  position: absolute;
  left: 50%;
  bottom: calc(24px + var(--viewport-bottom-offset, 0px));
  bottom: calc(
    24px + var(--viewport-bottom-offset, 0px) + constant(safe-area-inset-bottom)
  );
  bottom: calc(
    24px + var(--viewport-bottom-offset, 0px) + env(safe-area-inset-bottom, 0px)
  );
  transform: translateX(-50%);
  width: min(360px, calc(100vw - 32px));
  z-index: 3;
}

.landing__battle-button {
  box-shadow: 0 18px 32px rgba(0, 58, 128, 0.35);
}

@media (prefers-reduced-motion: reduce) {
  main.landing {
    transition: none;
  }

  body.is-preloading main.landing {
    transform: none;
    filter: none;
  }
}

.hero {
  position: absolute;
  left: 50%;
  top: 52%;
  animation: hero-float var(--hero-float-duration, 3.5s)
      cubic-bezier(0.42, 0, 0.58, 1) 1.35s
      infinite;
  max-width: min(320px, 70vw);
  max-height: min(320px, 70vh);
  transform: translate(-50%, calc(-50% - var(--hero-float-range, 32px)))
    scaleX(-1);
  transform-origin: 50% 85%;
  --hero-float-range: 32px;
  --hero-float-duration: 3.5s;
  image-rendering: auto;
  z-index: 2;
  pointer-events: none;
  will-change: transform, opacity;
  transition: left 0.7s cubic-bezier(0.22, 1, 0.36, 1);
}

.landing__hero-speech {
  position: absolute;
  top: calc(clamp(18%, 32vh, 44%) - 40px);
  left: 50%;
  transform: translate(-50%, -8px);
  max-width: min(420px, 100%);
  text-align: left;
  align-items: flex-start;
  opacity: 0;
  pointer-events: none;
  z-index: 3;
  transition: opacity 0.4s ease, transform 0.45s cubic-bezier(0.22, 1, 0.36, 1);
  --dialogue-tail-offset: 60%;
}

.landing__hero-speech.is-visible {
  opacity: 1;
  transform: translate(-50%, 0);
}

.landing__hero-speech-text {
  margin: 0;
  width: 100%;
  font-size: clamp(18px, 3.8vw, 22px);
  color: rgba(39, 43, 52, 0.95);
  letter-spacing: 0.01em;
}

.landing__hero-speech-text[data-typing='true']::after {
  content: none;
  animation: none;
}

.landing__hero-speech-text[data-typing='false']::after,
.landing__hero-speech-text:not([data-typing])::after {
  content: '';
}

@keyframes hero-speech-caret {
  0%,
  50% {
    opacity: 1;
  }
  51%,
  100% {
    opacity: 0;
  }
}

.hero.is-side-position {
  left: calc(50% - var(--intro-sprite-offset));
}

.hero.is-exiting {
  animation: hero-intro-exit 0.7s cubic-bezier(0.22, 1, 0.36, 1) forwards;
}

.enemy {
  --enemy-float-range: 28px;
  --enemy-float-duration: 3.8s;
  --enemy-float-offset: calc(-1 * var(--enemy-float-range));
  position: absolute;
  left: calc(50% + var(--intro-sprite-offset));
  top: 45%;
  max-width: min(320px, 70vw);
  max-height: min(320px, 70vh);
  transform: translate(
      -50%,
      calc(
        -50% - var(--enemy-drop-distance, 22vh) +
          var(--enemy-float-offset)
      )
    )
    scale(1.04);
  transform-origin: 50% 85%;
  opacity: 0;
  transition: transform 0.9s cubic-bezier(0.16, 1, 0.3, 1),
    opacity 0.6s ease-out;
  pointer-events: none;
  will-change: transform, opacity;
  z-index: 2;
}

.enemy.is-visible {
  transform: translate(
      -50%,
      calc(-50% + var(--enemy-float-offset))
    )
    scale(1);
  opacity: 1;
  animation: enemy-float var(--enemy-float-duration) cubic-bezier(0.42, 0, 0.58, 1)
      1.35s
      infinite;
}

.enemy.is-exiting {
  animation: enemy-intro-exit 0.6s cubic-bezier(0.22, 1, 0.36, 1) forwards;
}

body.is-level-one-landing .landing__hero-info,
body.is-level-one-landing .landing__actions {
  display: none;
}

body.is-level-one-landing .enemy {
  display: none;
}

body:not(.is-level-one-landing) .landing__hero-speech {
  display: none;
}

body.is-battle-transition {
  cursor: progress;
}

body.is-battle-transition .landing,
body.is-battle-transition .bubbles {
  pointer-events: none;
}

@keyframes hero-float {
  0% {
    transform: translate(-50%, calc(-50% - var(--hero-float-range, 32px)))
      scaleX(-1);
  }
  50% {
    transform: translate(-50%, calc(-50% + var(--hero-float-range, 32px)))
      scaleX(-1);
  }
  100% {
    transform: translate(-50%, calc(-50% - var(--hero-float-range, 32px)))
      scaleX(-1);
  }
}

@keyframes enemy-float {
  0% {
    --enemy-float-offset: calc(-1 * var(--enemy-float-range));
  }
  50% {
    --enemy-float-offset: var(--enemy-float-range);
  }
  100% {
    --enemy-float-offset: calc(-1 * var(--enemy-float-range));
  }
}

@media (prefers-reduced-motion: reduce) {
  .hero {
    animation: none;
    transform: translate(-50%, -50%) scaleX(-1);
  }

  .hero.is-exiting {
    opacity: 0;
  }

  .enemy {
    animation: none;
    transition: none;
    transform: translate(-50%, -50%);
    --enemy-float-offset: 0px;
    opacity: 1;
  }

  .enemy.is-exiting {
    opacity: 0;
  }

  main.landing.is-battle-transition {
    animation: none;
    transform: translate3d(0, 0, 0);
    filter: none;
  }

  .bubbles.is-battle-transition {
    animation: none;
    transform: translateX(-50%);
    opacity: 0;
  }
}

@keyframes hero-intro-exit {
  0% {
    transform: translate(-50%, calc(-50% - var(--hero-float-range, 32px)))
      scaleX(-1) scale(1);
    opacity: 1;
  }
  50% {
    transform: translate(-50%, calc(-50% - var(--hero-float-range, 32px)))
      scaleX(-1) scale(1.08);
    opacity: 1;
  }
  60% {
    transform: translate(-50%, calc(-50% - var(--hero-float-range, 32px)))
      scaleX(-1) scale(1.05);
    opacity: 0.96;
  }
  100% {
    transform: translate(-50%, calc(-50% - var(--hero-float-range, 32px)))
      scaleX(-1) scale(0.62);
    opacity: 0;
  }
}

@keyframes enemy-intro-exit {
  0% {
    transform: translate(-50%, -50%) scale(1);
    opacity: 1;
  }
  45% {
    transform: translate(-50%, -50%) scale(1.05);
    opacity: 1;
  }
  100% {
    transform: translate(-50%, -50%) scale(0.55);
    opacity: 0;
  }
}

@keyframes landing-battle-shift {
  0% {
    transform: translate3d(0, 0, 0) scale(1);
    filter: none;
  }
  36% {
    transform: translate3d(0, -6px, 0) scale(1.01);
    filter: saturate(1.05) brightness(1.02);
  }
  100% {
    transform: translate3d(0, -14px, 0) scale(1.03);
    filter: saturate(1.12) brightness(1.05);
  }
}

@keyframes bubble-field-fade {
  0% {
    transform: translate3d(-50%, 0, 0);
    opacity: 1;
  }
  100% {
    transform: translate3d(-50%, 18px, 0);
    opacity: 0;
  }
}

.card--home.is-battle-transition {
  will-change: transform, opacity;
  animation: card-pop-out 0.58s cubic-bezier(0.22, 1, 0.36, 1) forwards;
}

@keyframes card-pop-out {
  0% {
    transform: translate3d(
        var(--card-translate-x, -50%),
        var(--card-translate-y, 0),
        var(--card-translate-z, 0)
      )
      scale(1);
    opacity: 1;
  }
  25% {
    transform: translate3d(
        var(--card-translate-x, -50%),
        var(--card-translate-y, 0),
        var(--card-translate-z, 0)
      )
      scale(0.95);
    opacity: 1;
  }
  58% {
    transform: translate3d(
        var(--card-translate-x, -50%),
        var(--card-translate-y, 0),
        var(--card-translate-z, 0)
      )
      scale(1.07);
    opacity: 1;
  }
  100% {
    transform: translate3d(
        var(--card-translate-x, -50%),
        var(--card-translate-y, 0),
        var(--card-translate-z, 0)
      )
      scale(0.83);
    opacity: 0;
  }
}

@media (prefers-reduced-motion: reduce) {
  .card--home.is-battle-transition {
    opacity: 0;
  }
}

/* Bubble field */
.bubbles {
  position: absolute;
  left: 50%;
  bottom: 0;
  transform: translateX(-50%);
  display: flex;
  align-items: flex-end;
  justify-content: center;
  gap: clamp(24px, 8vw, 72px);
  width: min(720px, 100%);
  padding: 0 16px
    calc(
      clamp(120px, 22vh, 200px) +
      var(--viewport-bottom-offset, 0px)
    );
  padding: 0 16px
    calc(
      clamp(120px, 22vh, 200px) +
      var(--viewport-bottom-offset, 0px) +
      constant(safe-area-inset-bottom)
    );
  padding: 0 16px
    calc(
      clamp(120px, 22vh, 200px) +
      var(--viewport-bottom-offset, 0px) +
      env(safe-area-inset-bottom, 0px)
    );
  overflow: visible;
  pointer-events: none;
  z-index: 1;
  will-change: transform, opacity;
}

.bubbles.is-battle-transition {
  animation: bubble-field-fade 0.5s ease forwards;
}

/* ---- Realistic bubbles ----
   Using animatable custom properties so multiple animations can
   combine without fighting over 'transform'.
*/
@property --tx { syntax: '<length>'; initial-value: 0px; inherits: false; }
@property --ty { syntax: '<length>'; initial-value: 0px; inherits: false; }
@property --sx { syntax: '<number>'; initial-value: 1;   inherits: false; }
@property --sy { syntax: '<number>'; initial-value: 1;   inherits: false; }
@property --rot { syntax: '<angle>';  initial-value: 0deg; inherits: false; }

/* SUPER-realistic, clear “water glass” bubbles */
.bubble {
  --drift: 0px;
  position: relative;
  bottom: -80px;
  flex: 0 0 auto;
  width: var(--size);
  height: var(--size);
  border-radius: 50%;
  opacity: 0;

  /* Base: faint tint so it reads against any BG */
  background: radial-gradient(circle at 50% 45%,
    rgba(255,255,255,0.10) 0%,
    rgba(255,255,255,0.05) 40%,
    rgba(255,255,255,0.02) 65%,
    rgba(255,255,255,0.00) 100%);

  /* Subtle inner/outside glow for depth */
  box-shadow:
    inset 0 0 10px rgba(255,255,255,0.18),
    0 2px 12px rgba(120,170,220,0.12);

  /* Transform pipeline driven by variables (kept from your version) */
  transform: translate3d(var(--tx), var(--ty), 0) rotate(var(--rot)) scale(var(--sx), var(--sy));
  will-change: transform, opacity;

  animation:
    bubble-rise var(--duration) cubic-bezier(.22,.61,.36,1) infinite,
    bubble-drift calc(var(--duration) * 0.45) ease-in-out infinite alternate,
    bubble-wobble calc(var(--duration) * 0.38) ease-in-out infinite,
    bubble-spin   calc(var(--duration) * 0.9)  ease-in-out infinite alternate;
  animation-delay:
    var(--delay, 0s),
    var(--delay, 0s),
    var(--delay, 0s),
    var(--delay, 0s);

  /* Let highlights lift color beneath (gives glass pop) */
  mix-blend-mode: screen; /* harmless if BG is light; looks great on dark/colored scenes */
}

/* High-end refraction: only if supported (graceful fallback above) */
@supports ((-webkit-backdrop-filter: blur(1px)) or (backdrop-filter: blur(1px))) {
  .bubble {
    /* Clear glass feel: blur/saturate/brighten background seen through bubble */
    background: rgba(255,255,255,0.04); /* nearly clear */
    -webkit-backdrop-filter: blur(6px) saturate(130%) brightness(1.06);
            backdrop-filter: blur(6px) saturate(130%) brightness(1.06);
  }
}

/* RIM: crisp thin edge using a mask so center stays clear */
.bubble::before,
.bubble::after {
  content: '';
  position: absolute;
  inset: 0;
  border-radius: 50%;
  pointer-events: none;
}

/* Thin luminous rim + micro-rainbow sheen */
.bubble::before {
  /* ring drawn by mask; shows only the outer band */
  background:
    conic-gradient(from 210deg,
      rgba(255,255,255,0.35) 0deg,
      rgba(255,255,255,0.18) 120deg,
      rgba(200,230,255,0.20) 180deg,
      rgba(255,255,255,0.28) 270deg,
      rgba(255,255,255,0.35) 360deg);
  -webkit-mask: radial-gradient(closest-side,
      transparent calc(100% - 2.5px), /* ring thickness */
      #000 calc(100% - 2.0px));
          mask: radial-gradient(closest-side,
      transparent calc(100% - 2.5px),
      #000 calc(100% - 2.0px));
  filter: blur(0.6px);         /* soften rim a hair */
  opacity: 0.9;
  mix-blend-mode: screen;
}

/* SPECULAR HIGHLIGHTS: small bright dot + soft lens inside */
.bubble::after {
  /* two-layer highlight packed into one pseudo for perf */
  background:
    radial-gradient(20% 20% at 30% 28%, rgba(255,255,255,0.88) 0%, rgba(255,255,255,0.0) 100%),
    radial-gradient(60% 50% at 55% 45%, rgba(255,255,255,0.20) 0%, rgba(255,255,255,0.06) 60%, rgba(255,255,255,0.0) 100%);
  filter: blur(2.2px);
  opacity: 0.85;
  mix-blend-mode: screen;
}

/* Keep your gentle drift bias without time staggering */
.bubble:nth-of-type(odd) { --drift: 12px; }
.bubble:nth-of-type(3n)  { --drift: -10px; }


/* Rise: non-linear opacity + slight pressure expansion as it ascends */
@keyframes bubble-rise {
  0%   { --ty: 0px;                 --sx: 0.95; --sy: 0.95; opacity: 0; }
  10%  {                            --sx: 0.98; --sy: 0.98; opacity: 0.45; }
  40%  {                            --sx: 1.02; --sy: 1.02; opacity: 0.92; }
  100% { --ty: -110vh;              --sx: 1.06; --sy: 1.06; opacity: 0; }
}

.battle-intro {
  position: fixed;
  left: var(--battle-intro-left, 50%);
  top: var(--battle-intro-top, 50%);
  transform: translate(-50%, -50%);
  display: flex;
  align-items: center;
  justify-content: center;
  pointer-events: none;
  opacity: 0;
  visibility: hidden;
  z-index: 3;
}

.battle-intro__image {
  width: min(350px, 90vw);
  height: min(350px, 90vw);
  object-fit: contain;
  transform: scale(0.2);
  transform-origin: center;
  opacity: 0;
}

.battle-intro.is-visible {
  opacity: 1;
  visibility: visible;
}

.battle-intro__image.is-pop-in {
  animation: battle-intro-pop 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
}

.battle-intro__image.is-pop-out {
  animation: battle-intro-pop-out 0.45s cubic-bezier(0.16, 1, 0.3, 1) forwards;
}

@keyframes battle-intro-pop {
  0% {
    transform: scale(0.2);
    opacity: 0;
  }
  60% {
    transform: scale(1.12);
    opacity: 1;
  }
  100% {
    transform: scale(1);
    opacity: 1;
  }
}

@keyframes battle-intro-pop-out {
  0% {
    transform: scale(1);
    opacity: 1;
  }
  40% {
    transform: scale(1.08);
    opacity: 1;
  }
  100% {
    transform: scale(0.2);
    opacity: 0;
  }
}

@media (prefers-reduced-motion: reduce) {
  .battle-intro {
    transition: none;
  }

  .battle-intro__image {
    transform: scale(1);
    opacity: 1;
  }
}

/* Organic horizontal meander tied to --drift */
@keyframes bubble-drift {
  0%   { --tx: calc(var(--drift) * -1); }
  100% { --tx: calc(var(--drift)); }
}

/* Water wobble: subtle squash & stretch out of phase */
@keyframes bubble-wobble {
  0%   { --sx: calc(var(--sx));   --sy: calc(var(--sy)); }
  25%  { --sx: calc(var(--sx) * 0.985); --sy: calc(var(--sy) * 1.015); }
  50%  { --sx: calc(var(--sx) * 1.01);  --sy: calc(var(--sy) * 0.99); }
  75%  { --sx: calc(var(--sx) * 0.99);  --sy: calc(var(--sy) * 1.01); }
  100% { --sx: calc(var(--sx));   --sy: calc(var(--sy)); }
}

/* Tiny spin for parallax sparkle */
@keyframes bubble-spin {
  0%   { --rot: -2deg; }
  100% { --rot: 3deg; }
}

/* ------------------------------------------------------------------------- */
/* Simple preload experience ---------------------------------------------- */

.preloader {
  --app-safe-area-padding: clamp(24px, 6vw, 48px);
  position: fixed;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 24px;
  background-color: #001b41;
  z-index: 10;
  text-align: center;
  transition: opacity 0.4s ease;
  padding-top: calc(
    var(--app-safe-area-padding) + env(safe-area-inset-top, 0px)
  );
  padding-bottom: calc(
    var(--app-safe-area-padding) + env(safe-area-inset-bottom, 0px)
  );
  padding-left: calc(
    var(--app-safe-area-padding) + env(safe-area-inset-left, 0px)
  );
  padding-right: calc(
    var(--app-safe-area-padding) + env(safe-area-inset-right, 0px)
  );
  box-sizing: border-box;
}

.preloader__logo {
  width: min(200px, 45vw);
  height: min(200px, 45vw);
  max-width: 200px;
  max-height: 200px;
  object-fit: contain;
}

.preloader__text {
  margin: 0;
  font-size: var(--text-size-large);
  color: var(--text-color-light);
}

.preloader__spinner {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  border: 6px solid rgba(255, 255, 255, 0.2);
  border-top-color: #ffffff;
  animation: preloader-spin 1s linear infinite;
}

.preloader--hidden {
  opacity: 0;
  pointer-events: none;
}

@media (prefers-reduced-motion: reduce) {
  .preloader {
    transition: none;
  }

  .preloader__spinner {
    animation-duration: 0s;
  }
}

@keyframes preloader-spin {
  to {
    transform: rotate(360deg);
  }
}


.pwa-install {
  position: relative;
  z-index: 7;
  margin: clamp(16px, 4vw, 32px)
    auto
    calc(clamp(40px, 8vh, 96px) + env(safe-area-inset-bottom, 0px));
  padding: clamp(16px, 4vw, 32px);
  max-width: min(420px, 90%);
  border-radius: 28px;
  background: rgba(255, 255, 255, 0.92);
  box-shadow: 0 18px 48px rgba(14, 57, 93, 0.25);
  display: flex;
  flex-direction: column;
  gap: 16px;
  text-align: center;
  color: #0a3d62;
  backdrop-filter: blur(6px);
}

@supports not ((backdrop-filter: blur(6px))) {
  .pwa-install {
    background: rgba(255, 255, 255, 0.98);
  }
}

.pwa-install__title {
  margin: 0;
  font-size: clamp(1.25rem, 2vw, 1.6rem);
  letter-spacing: 0.03em;
}

.pwa-install__message {
  margin: 0;
  font-size: clamp(0.95rem, 1.8vw, 1.05rem);
  line-height: 1.5;
  color: rgba(10, 61, 98, 0.85);
}

.pwa-install__actions {
  display: flex;
  flex-direction: column;
  gap: 12px;
  align-items: center;
}

.pwa-install__button {
  width: min(260px, 100%);
}

.pwa-install__link {
  color: #0a3d62;
  text-decoration: none;
}

.pwa-install__link:hover,
.pwa-install__link:focus {
  text-decoration: underline;
}

@media (min-width: 768px) {
  .pwa-install {
    position: absolute;
    bottom: calc(clamp(32px, 5vh, 72px) + env(safe-area-inset-bottom, 0px));
    right: clamp(32px, 6vw, 96px);
    margin: 0;
    text-align: left;
    align-items: flex-start;
  }

  .pwa-install__actions {
    flex-direction: row;
    justify-content: flex-start;
  }

  .pwa-install__link {
    font-size: 0.95rem;
  }
}
